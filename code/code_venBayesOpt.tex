\begin{mdframed}
\begin{minipage}{\linewidth}
\small
\belowcaptionskip=-10pt
\begin{lstlisting}[caption={Bayesian optimization using \gpmem},mathescape,numbers=none,label=alg:bayesopt,escapechar=\#]
#\linenumber{1}#assume sf = tag("hyper", 0, uniform_continuous(0, 10))
#\linenumber{2}#assume l = tag("hyper", 1, uniform_continuous(0, 10))
#\linenumber{3}#assume se = make_squaredexp(sf, l)
#\linenumber{4}#assume blackbox_f = get_bayesopt_blackbox()
#\linenumber{5}#assume (f_compute, f_emulate) = gpmem(blackbox_f, se)

// A naive estimate of the argmax of the given function
#\linenumber{6}#define mc_argmax = proc(func) {
#\linenumber{7}#  candidate_xs = mapv(proc(i) {uniform_continuous(-20, 20)},
#\linenumber{8}#                      arange(20));
#\linenumber{9}#  candidate_ys = mapv(func, candidate_xs);
#\linenumber{10}#  lookup(candidate_xs, argmax_of_array(candidate_ys))
#\linenumber{11}#};

// Shortcut to sample the emulator at a single point without packing
// and unpacking arrays
#\linenumber{12}#define emulate_pointwise = proc(x) {
#\linenumber{13}#  run(sample(lookup(f_emulate(array(unquote(x))), 0)))
#\linenumber{14}#};

// Main inference loop
#\linenumber{15}#infer repeat(15, do(pass,
  // Probe V at the point mc_argmax(emulate_pointwise)
#\linenumber{16}#  predict(f_compute(unquote(mc_argmax(emulate_pointwise)))),
  // Infer hyperparameters
#\linenumber{17}#  mh("hyper", one, 50)));
\end{lstlisting}

\end{minipage}
\end{mdframed}
